#!/bin/sh
# IPython release script

version=`ipython -Version`
ipdir=~/ipython/ipython

echo
echo "Releasing IPython version $version"
echo "=================================="

echo "Marking ChangeLog with release information and making NEWS file..."

# Stamp changelog and save a copy of the status at each version, in case later
# we want the NEWS file to start from a point before the very last release (if
# very small interim releases have no significant changes).

cd $ipdir/doc
cp ChangeLog ChangeLog.old
cp ChangeLog ChangeLog.$version
daystamp=`date +%Y-%m-%d`
echo $daystamp " ***" Released version $version > ChangeLog
echo >> ChangeLog
cat ChangeLog.old >> ChangeLog
rm ChangeLog.old

# Build NEWS file
echo "Changes between the last two releases (major or minor)" > NEWS
echo "Note that this is an auto-generated diff of the ChangeLogs" >> NEWS
echo >> NEWS
diff ChangeLog.previous ChangeLog | grep -v '^0a' | sed 's/^> //g' >> NEWS
cp ChangeLog ChangeLog.previous

# Update gzipped copies of the manpages
gzip -9c ipython.1 > ipython.1.gz
gzip -9c pycolor.1 > pycolor.1.gz

# Clean up dist directory
cd $ipdir/dist
rm -f *

# Perform local backup
cd $ipdir/tools
./bkp.py

# Build source and binary distros
cd $ipdir
#./setup.py sdist --formats=gztar,zip bdist --formats=rpm,wininst
./setup.py sdist --formats=gztar,zip bdist --formats=rpm

# Upload all files
cd $ipdir/dist
echo "Uploading distribution files..."
scp * fperez@scipy.org:www/dist/

echo "Uploading backup files..."
cd ~/ipython/backup
scp `ls -1tr | tail -1` fperez@scipy.org:www/backup/

echo "Updating webpage..."
cd $ipdir/doc
www=~/ipython/homepage
cp ChangeLog NEWS $www
rm -rf $www/doc/*
cp -r manual.pdf manual/ $www/doc
cd $www
./update

# Alert package maintainers
echo "Alerting package maintainers..."
maintainers='fperez@colorado.edu ariciputi@users.sourceforge.net jack@xiph.org \
dryice@hotpop.com'

for email in $maintainers
    do
	echo "Emailing $email..."
	mail -s "[Package maintainer notice] A new IPython is out. Version: $version" \
    $email < NEWS
    done

echo "Done!"
